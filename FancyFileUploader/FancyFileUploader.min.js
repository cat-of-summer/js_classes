class FancyFileUploader{constructor({target_selector:e,draggble_zone_selector:t,add_button_selector:i,files_list_selector:a,file_template:l,max_files:s=0,max_file_size:r=0,max_total_size:n=0,input_name:o="files[]",human_readable_size:c=!1}){let d;this.targets=document.querySelectorAll(e),this.draggble_selector=t,this.add_button_selector=i,this.files_list_selector=a,this.max_files=s,this.max_file_size=r,this.max_total_size=n,this.input_name=o,this.human_readable_size=c;try{const e=document.querySelectorAll(l);e.length>0?(d=e[0].outerHTML,e.forEach(e=>e.remove())):d=l}catch{d=l}this.file_template=d,this.targets.forEach(e=>this.initTarget(e))}initTarget(e){e.fileCount=0,e.totalSize=0;const t=e.querySelectorAll(this.draggble_selector),i=e.querySelectorAll(this.add_button_selector),a=e.querySelector(this.files_list_selector);if(!a)return;const l=t=>{Array.from(t).forEach(t=>{if(this.max_files>0&&e.fileCount>=this.max_files)return void alert(`Максимум файлов: ${this.max_files}`);if(this.max_file_size>0&&t.size>this.max_file_size)return void alert(`Файл "${t.name}" слишком большой! Максимум ${this.formatSize(this.max_file_size)}.`);if(this.max_total_size>0&&e.totalSize+t.size>this.max_total_size)return void alert(`Превышен общий лимит! Максимальная сумма всех файлов ${this.formatSize(this.max_total_size)}.`);const i=this.createFileEntry(t,e);a.appendChild(i),e.fileCount++,e.totalSize+=t.size})};t.forEach(e=>{["dragenter","dragover"].forEach(t=>e.addEventListener(t,t=>{t.preventDefault(),e.classList.add("dragover")})),["dragleave","drop"].forEach(t=>e.addEventListener(t,t=>{t.preventDefault(),e.classList.remove("dragover")})),e.addEventListener("drop",e=>{e.preventDefault(),l(e.dataTransfer.files)})}),i.forEach(t=>{t.addEventListener("click",()=>{if(this.max_files>0&&e.fileCount>=this.max_files)return void alert(`Максимум файлов: ${this.max_files}`);const t=document.createElement("input");t.type="file",t.accept="image/*",t.style.display="none",t.multiple=1!==this.max_files,t.addEventListener("change",()=>l(t.files)),document.body.appendChild(t),t.click()})})}formatSize(e){if(!this.human_readable_size)return(e/1024).toFixed(1)+" КБ";const t=["Б","КБ","МБ","ГБ","ТБ"];let i=0;for(;e>=1024&&i<t.length-1;)e/=1024,i++;return e.toFixed(1)+" "+t[i]}createFileEntry(e,t){const i=document.createElement("div");i.innerHTML=this.file_template.trim();const a=i.firstElementChild;a.dataset.size=e.size;const l=a.querySelectorAll("img[preview]"),s=a.querySelectorAll("[filename]"),r=a.querySelectorAll("[fileweight]"),n=a.querySelectorAll("[delete_button]");if(e.type.startsWith("image/")){const t=new FileReader;t.onload=e=>l.forEach(t=>t.src=e.target.result),t.readAsDataURL(e)}else l.forEach(e=>e.remove());s.forEach(t=>t.textContent=e.name),r.forEach(t=>t.textContent=this.formatSize(e.size)),n.forEach(e=>{e.addEventListener("click",()=>{a.remove(),t.fileCount=Math.max(0,t.fileCount-1),t.totalSize=Math.max(0,t.totalSize-parseInt(a.dataset.size))})});const o=document.createElement("input");o.type="file";let c=this.input_name;1!==this.max_files?c.endsWith("[]")||(c+="[]"):c.endsWith("[]")&&(c=c.slice(0,-2)),o.name=c,o.style.display="none";const d=new DataTransfer;return d.items.add(e),o.files=d.files,a.appendChild(o),a}}