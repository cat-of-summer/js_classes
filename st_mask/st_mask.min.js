class st_mask{#e="_";#s=!0;#a=[];#t=[];#r(e,s){let a="",t=0,r=0;for(let l of s)for(;r+t<e.length;){let[s,i,_]=e[r+t];if(i){new RegExp(`^${s}$`).test(l)&&(a+=l,r++);break}a+=s,t++}if(this.#e&&this.#s)for(;r+t<e.length;)a+=e[r+t++][1]?e[r+t-1][2]:e[r+t-1][0];else r?r+t<e.length&&!e[r+t][1]&&(a+=e[r+t++][0]):a="";return[a,r,e.filter((e=>e[1])).length==r]}#l(e){return this.#a.map((s=>this.#r(s,e))).reduce(((e,s,a)=>!e||s[1]>e[0][1]?[s,a]:e),null)}#i(e){return e.replace(/{(\d+)\*{([^}]*?)}(.*?)}/g,((e,s,a,t)=>`{{${a}}${t}}`.repeat(s))).split(/({{.*?}.*?})/).filter(Boolean).map((e=>{let[,s]=e.match(/^{{(.*?)}.*?}$/)||[],[,a]=e.match(/^{{.*?}=(.*?)}$/)||[];return[s||e,!!s,a||this.#e]}))}#_(e=null){this.#m()?console.warn("Попытка обновить маску после удаления правил",this):(e?[e]:this.#t).forEach((e=>{e.best_mask=this.#l(e.value),e.input.value=e.best_mask[0][0],Object.assign(e.input.dataset,{mask_id:e.best_mask[1],progress:e.best_mask[0][1],is_full:e.best_mask[0][2]})}))}#m(){return!this.#a.some((e=>null!=!e))}add_mask(e){return this.#a.push(this.#i(e)),this.#_(),this.#a.length-1}remove_mask(e){delete this.#a[e],this.#_()}set_masks(e){this.#a=e.map((e=>this.#i(e))),this.#_()}constructor(e){let s=this;s.#e=e.default_filler??s.#e,s.#s=e.placeholder??s.#s,document.querySelectorAll(e.selector).forEach((a=>{let t={input:a,value:a.value.split().filter(Boolean)};a.addEventListener("input",(r=>{if(r.preventDefault(),this.#m())console.error("Нет масок для этого поля.",this);else{if(null===r.data){let e=[];for(let s of t.value)if(e.push(s),this.#r(this.#a[t.best_mask[1]],e)[1]==t.best_mask[0][1]){e.pop();break}t.value=e}else t.value.push(...r.data);s.#_(t),"function"==typeof e.on_input&&e.on_input(a,{mask_id:t.best_mask[1],progress:t.best_mask[0][1],is_full:t.best_mask[0][2]})}})),"function"==typeof e.on_init&&e.on_init(a),s.#t.push(t)})),e.masks&&s.set_masks(e.masks)}}